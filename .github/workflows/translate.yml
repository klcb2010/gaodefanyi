name: 繁体 → 简体（strings 文件）

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码（带完整历史）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          pip install --no-cache-dir opencc-python-reimplemented

      - name: 查找并转换所有 zh-rHK / zh-rTW 文件
        id: find-files
        run: |
          echo "开始查找繁体中文 strings 文件..."

          mapfile -t files < <(find . -type f \
            \( -name "*zh-rHK*.xml" -o -name "*zh-rTW*.xml" \
            -o -name "*zh-rHK*.txt" -o -name "*zh-rTW*.txt" \) \
            ! -name "*_sc.*" -not -path "*/.git/*" 2>/dev/null || true)

          if [ ${#files[@]} -eq 0 ]; then
            echo "未找到任何符合条件的繁体文件"
            echo "files_found=false" >> $GITHUB_OUTPUT
          else
            echo "找到 ${#files[@]} 个文件："
            printf '%s\n' "${files[@]}"
            echo "开始执行转换..."
            python converter.py "${files[@]}"
            echo "files_found=true" >> $GITHUB_OUTPUT
          fi

      - name: 提交生成的 _sc 文件（每次都提交 + 强制 add + debug）
        if: steps.find-files.outputs.files_found == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          echo "=== 当前目录结构 ==="
          ls -la

          echo "=== 列出所有生成的 _sc 文件 ==="
          find . -type f -name "*_sc.*" -print || echo "没有找到任何 _sc 文件！"

          echo "=== git status 前 ==="
          git status

          # 明確逐個強制 add 找到的 _sc 文件
          mapfile -t sc_files < <(find . -type f -name "*_sc.*" -print 2>/dev/null || true)
          if [ ${#sc_files[@]} -gt 0 ]; then
            for file in "${sc_files[@]}"; do
              git add -f "$file" && echo "已成功 add: $file"
            done
          else
            echo "警告：沒有找到任何 _sc 文件，無法 add"
          fi

          echo "=== git status 后 add ==="
          git status

          # 強制 commit，即使沒有變化
          git commit --allow-empty -m "chore: 繁体 → 简体转换执行 ($(date '+%Y-%m-%d %H:%M:%S')) [ci skip]"

          echo "=== 最新 commit 详情 ==="
          git log -1 --stat

          # 推送
          git push origin HEAD:${{ github.ref_name }}
          echo "推送完成"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传转换结果作为 Artifact（备用检查）
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simplified-strings
          path: |
            **/*_sc.*
          if-no-files-found: warn
