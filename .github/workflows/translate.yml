name: 繁体 → 简体（strings 文件）

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          pip install --no-cache-dir opencc-python-reimplemented

      - name: 查找并转换所有 zh-rHK / zh-rTW 文件
        run: |
          echo "开始查找繁体中文 strings 文件..."

          # 查找常见位置的文件（可根据你的仓库结构修改模式）
          mapfile -t files < <(find . -type f \
            \( -name "*zh-rHK*.xml" -o -name "*zh-rTW*.xml" \
            -o -name "*zh-rHK*.txt" -o -name "*zh-rTW*.txt" \) \
            ! -name "*_sc.*" 2>/dev/null)

          if [ ${#files[@]} -eq 0 ]; then
            echo "未找到任何符合条件的繁体文件，结束。"
            exit 0
          fi

          echo "找到 ${#files[@]} 个文件，开始转换..."

          python converter.py "${files[@]}"

      - name: 提交转换后的 _sc 文件
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # 添加所有新生成的 _sc 文件
          git add **/*_sc.* 2>/dev/null || true

          # 只在有实际变更时提交
          git diff --cached --quiet || git commit -m "chore: 自动转换繁体 → 简体（$(date '+%Y-%m-%d %H:%M:%S')）"

          git push || echo "无内容推送或推送失败"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传转换结果（Artifact）
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simplified-strings
          path: |
            **/*_sc.*
          if-no-files-found: warn
